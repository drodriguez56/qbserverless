{"version":3,"sources":["webpack:///webpack/bootstrap d176781825ce547c0543","webpack:///external \"request\"","webpack:///./config.json","webpack:///external \"mongoose\"","webpack:///external \"csrf\"","webpack:///./tools/tools.js","webpack:///./handler.js","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"babel-runtime/core-js/promise\"","webpack:///external \"client-oauth2\"","webpack:///./tools/openid_configuration.json","webpack:///external \"btoa\"","webpack:///./tools/jwt.js","webpack:///external \"atob\"","webpack:///external \"expect\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"rsa-pem-from-mod-exp\"","webpack:///external \"jwt-decode\"","webpack:///external \"bluebird\"","webpack:///./src/models/User.js","webpack:///./src/models/Company.js"],"names":["Tokens","require","csrf","ClientOAuth2","request","config","Tools","tools","openid_configuration","authConfig","clientId","process","env","QB_CONSUMER_KEY","clientSecret","QB_CONSUMER_SECRET","redirectUri","authorizationUri","authorization_endpoint","accessTokenUri","token_endpoint","basicAuth","refreshEndpoints","url","configurationEndpoint","headers","Accept","err","response","console","log","json","JSON","parse","body","openid_uri","userinfo_endpoint","revoke_uri","revocation_endpoint","intuitAuth","checkForUnauthorized","req","requestObj","resolve","reject","statusCode","refreshTokens","session","then","newToken","Authorization","accessToken","token","getToken","refresh","saveToken","setScopes","flowName","scopes","containsOpenId","includes","generateAntiForgery","secret","secretSync","create","verifyAntiForgery","verify","clearToken","refreshToken","tokenType","data","createToken","module","exports","mongoString","MONGO_URL","Promise","qbAuthUrl","event","context","callback","uri","code","getUri","state","succeed","location","qbCallback","realmId","done","Error","errorFn","e","Referer","id_token","validate","message","connected","companyId","db","errs","user","mongooseId","connect","useMongoClient","email","firstname","givenName","lastname","familyName","once","findById","save","company","users","push","id","catch","createErrorResponse","finally","close","createCompany","userAttributes","fail","pathParameters","find","_id","populate","path","loadReport","reportType","startDate","endDate","api_uri","atob","expect","JWT","jwt","token_parts","split","idTokenHeader","idTokenPayload","idTokenSignature","iss","toEqual","issuer","aud","exp","toBeGreaterThan","Date","now","getKeyFromJWKsURI","kid","key","cert","getPublicKey","n","jwks_uri","error","keys","el","modulus","exponent","getPem","pem","Schema","UserSchema","type","String","required","User","model","CompanySchema","Types","ObjectId","ref","Company"],"mappings":"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","file":"handler.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 5);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap d176781825ce547c0543","module.exports = require(\"request\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"request\"\n// module id = 0\n// module chunks = 0","module.exports = {\"redirectUri\":\"http://localhost:3000/callback/\",\"configurationEndpoint\":\"https://developer.api.intuit.com/.well-known/openid_sandbox_configuration/\",\"api_uri\":\"https://sandbox-quickbooks.api.intuit.com/v3/company/\",\"scopes\":{\"sign_in_with_intuit\":[\"openid\",\"profile\",\"email\",\"phone\",\"address\"],\"connect_to_quickbooks\":[\"com.intuit.quickbooks.accounting\"],\"connect_handler\":[\"com.intuit.quickbooks.accounting\",\"openid\",\"profile\",\"email\",\"phone\",\"address\"]}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./config.json\n// module id = 1\n// module chunks = 0","module.exports = require(\"mongoose\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongoose\"\n// module id = 2\n// module chunks = 0","module.exports = require(\"csrf\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"csrf\"\n// module id = 3\n// module chunks = 0","var Tokens = require(\"csrf\");\nvar csrf = new Tokens();\nvar ClientOAuth2 = require(\"client-oauth2\");\nvar request = require(\"request\");\nvar config = require(\"../config.json\");\n\nvar Tools = function() {\n  var tools = this;\n\n  // Use a local copy for startup.  This will be updated in refreshEndpoints() to call:\n  // https://developer.api.intuit.com/.well-known/openid_configuration/\n  this.openid_configuration = require(\"./openid_configuration.json\");\n\n  var authConfig = {\n    clientId: process.env.QB_CONSUMER_KEY,\n    clientSecret: process.env.QB_CONSUMER_SECRET,\n    redirectUri: config.redirectUri,\n    authorizationUri: this.openid_configuration.authorization_endpoint,\n    accessTokenUri: this.openid_configuration.token_endpoint\n  };\n\n  this.basicAuth = require(\"btoa\")(\n    authConfig.clientId + \":\" + authConfig.clientSecret\n  );\n\n  // Should be called at app start & scheduled to run once a day\n  // Get the latest OAuth/OpenID endpoints from Intuit\n  this.refreshEndpoints = function() {\n    request(\n      {\n        // Change this to Sandbox or non-sandbox in `config.json`\n        // Non-sandbox: https://developer.api.intuit.com/.well-known/openid_configuration/\n        // Sandbox: https://developer.api.intuit.com/.well-known/openid_sandbox_configuration/\n        url: config.configurationEndpoint,\n        headers: {\n          Accept: \"application/json\"\n        }\n      },\n      function(err, response) {\n        if (err) {\n          console.log(err);\n          return err;\n        }\n\n        // Update endpoints\n        var json = JSON.parse(response.body);\n        tools.openid_configuration = json;\n        tools.openid_uri = json.userinfo_endpoint;\n        tools.revoke_uri = json.revocation_endpoint;\n\n        // Re-create OAuth2 Client\n        authConfig.authorizationUri = json.authorization_endpoint;\n        authConfig.accessTokenUri = json.token_endpoint;\n        tools.intuitAuth = new ClientOAuth2(authConfig);\n      }\n    );\n  };\n\n  // Should be used to check for 401 response when making an API call.  If a 401\n  // response is received, refresh tokens should be used to get a new access token,\n  // and the API call should be tried again.\n  this.checkForUnauthorized = function(req, requestObj, err, response) {\n    return new Promise(function(resolve, reject) {\n      if (response.statusCode == 401) {\n        console.log(\"Received a 401 response!  Trying to refresh tokens.\");\n\n        // Refresh the tokens\n        tools.refreshTokens(req.session).then(\n          function(newToken) {\n            // Try API call again, with new accessToken\n            requestObj.headers.Authorization = \"Bearer \" + newToken.accessToken;\n            console.log(\"Trying again, making API call to: \" + requestObj.url);\n            request(requestObj, function(err, response) {\n              // Logic (including error checking) should be continued with new\n              // err/response objects.\n              resolve({ err, response });\n            });\n          },\n          function(err) {\n            // Error refreshing the tokens\n            reject(err);\n          }\n        );\n      } else {\n        // No 401, continue!\n        resolve({ err, response });\n      }\n    });\n  };\n\n  // Refresh Token should be called if access token expires, or if Intuit\n  // returns a 401 Unauthorized.\n  this.refreshTokens = function(session) {\n    var token = this.getToken(session);\n\n    // Call refresh API\n    return token.refresh().then(function(newToken) {\n      // Store the new tokens\n      tools.saveToken(session, newToken);\n      return newToken;\n    });\n  };\n\n  this.setScopes = function(flowName) {\n    authConfig.scopes = config.scopes[flowName];\n    tools.intuitAuth = new ClientOAuth2(authConfig);\n  };\n\n  this.containsOpenId = function() {\n    if (!authConfig.scopes) return false;\n    return authConfig.scopes.includes(\"openid\");\n  };\n\n  // Setup OAuth2 Client with values from config.json\n  this.intuitAuth = new ClientOAuth2(authConfig);\n\n  // Get anti-forgery token to use for state\n  this.generateAntiForgery = function(session) {\n    session.secret = csrf.secretSync();\n    return csrf.create(session.secret);\n  };\n\n  this.verifyAntiForgery = function(session, token) {\n    return csrf.verify(session.secret, token);\n  };\n\n  this.clearToken = function(session) {\n    session.accessToken = null;\n    session.refreshToken = null;\n    session.tokenType = null;\n    session.data = null;\n  };\n\n  // Save token into session storage\n  // In a real use-case, this is where tokens would have to be persisted (to a\n  // a SQL DB, for example).  Both access tokens and refresh tokens need to be\n  // persisted.  This should typically be stored against a user / realm ID, as well.\n  this.saveToken = function(session, token) {\n    session.accessToken = token.accessToken;\n    session.refreshToken = token.refreshToken;\n    session.tokenType = token.tokenType;\n    session.data = token.data;\n    return session;\n  };\n\n  // Get the token object from session storage\n  this.getToken = function(session) {\n    if (!session.accessToken) return null;\n\n    return tools.intuitAuth.createToken(\n      session.accessToken,\n      session.refreshToken,\n      session.tokenType,\n      session.data\n    );\n  };\n\n  this.refreshEndpoints();\n};\n\nmodule.exports = new Tools();\n\n\n\n// WEBPACK FOOTER //\n// ./tools/tools.js","import request from \"request\";\nimport Tokens from \"csrf\";\nimport tools from \"./tools/tools\";\nimport jwt from \"./tools/jwt\";\nimport decode from \"jwt-decode\";\nimport bluebird from \"bluebird\";\n\nimport mongoose from \"mongoose\";\nimport User from \"./src/models/User\";\nimport Company from \"./src/models/Company\";\n\nimport config from \"./config.json\";\n\nconst csrf = new Tokens();\nconst mongoString = process.env.MONGO_URL;\n\nmongoose.Promise = bluebird;\n\nconst generateAntiForgery = session => {\n  session.secret = csrf.secretSync();\n  return csrf.create(session.secret);\n};\n\nexport const qbAuthUrl = (event, context, callback) => {\n  tools.setScopes(\"connect_handler\");\n  // Constructs the authorization URI.\n  const uri = tools.intuitAuth.code.getUri({\n    // Add CSRF protection\n    state: tools.generateAntiForgery({})\n  });\n\n  console.log(\"Redirecting to authorization uri: \" + uri);\n\n  context.succeed({ location: uri });\n};\n\nexport const qbCallback = (event, context, callback) => {\n  const realmId = event.body.realmId;\n  if (!realmId) {\n    return context.done(\n      new Error(\"Error - cant connect without company id\"),\n      {}\n    );\n  }\n  // if (e)) {\n  //   return context.done(\n  //     new Error(\"Error - invalid anti-forgery CSRF response!\"),\n  //     {}\n  //   );\n  // }\n  const errorFn = e => {\n    console.log(e);\n    return callback(new Error(e), {});\n  };\n  tools.intuitAuth.code.getToken(event.headers.Referer).then(\n    function(token) {\n      // TODO: Store token - this would be where tokens would need to be\n      // save realmIdnd token as new client on company\n      const session = tools.saveToken({}, token);\n      if (token.data.id_token) {\n        try {\n          // We should decode and validate the ID token\n          jwt.validate(\n            token.data.id_token,\n            () => {\n              callback(null, { session: session });\n            },\n            errorFn\n          );\n        } catch (e) {\n          return errorFn(e);\n        }\n      } else {\n        callback(null, { message: \"connected\" });\n      }\n    },\n    err => {\n      return errorFn(err);\n    }\n  );\n};\n\nexport const connected = (event, context, callback) => {\n  const companyId = event.body.companyId;\n  if (!companyId)\n    return context.done(\n      new Error(\n        \"No realm ID.  QBO calls only work if the accounting scope was passed!\"\n      ),\n      {}\n    );\n  const token = tools.getToken(event.body.session);\n  const url = tools.openid_configuration.userinfo_endpoint;\n  console.log(\"Making API call to: \" + url);\n  const requestObj = {\n    url: url,\n    headers: {\n      Authorization: \"Bearer \" + token.accessToken,\n      Accept: \"application/json\"\n    }\n  };\n  request(requestObj, (err, response) => {\n    // Check if 401 response was returned - refresh tokens if so!\n    tools.checkForUnauthorized(event.body, requestObj, err, response).then(\n      ({ err, response }) => {\n        if (err || response.statusCode != 200) {\n          return context.done(new Error(err), {});\n        }\n\n        // API Call was a success!\n        const data = JSON.parse(response.body);\n        let db = {};\n        let errs = {};\n        let user = {};\n        const mongooseId = \"_id\";\n\n        db = mongoose.connect(mongoString, {\n          useMongoClient: true\n        });\n        user = new User({\n          email: data.email,\n          firstname: data.givenName,\n          lastname: data.familyName,\n          session: JSON.stringify(event.body.session)\n        });\n        console.log(\"starting db save\");\n        db.once(\"open\", () => {\n          Company.findById(companyId)\n            .then(company => {\n              return user.save().then(() => {\n                company.users.push(user);\n                return company.save();\n              });\n            })\n            .then(() => {\n              callback(null, {\n                statusCode: 200,\n                body: JSON.stringify({ id: user[mongooseId] })\n              });\n            })\n            .catch(err => {\n              console.log(err);\n              callback(null, createErrorResponse(err.statusCode, err.message));\n            })\n            .finally(() => {\n              db.close();\n            });\n        });\n      },\n      err => {\n        console.log(err);\n        return context.done(new Error(err), {});\n      }\n    );\n  });\n};\nconst createErrorResponse = (statusCode, message) => ({\n  statusCode: statusCode || 501,\n  headers: { \"Content-Type\": \"text/plain\", \"Access-Control-Allow-Origin\": \"*\" },\n  body: message || \"Incorrect id\"\n});\n\n//USER\n\nexport const createCompany = (event, context, callback) => {\n  let db = {};\n  let errs = {};\n  let company = {};\n  const mongooseId = \"_id\";\n\n  db = mongoose.connect(mongoString, {\n    useMongoClient: true\n  });\n\n  company = new Company({\n    email: event.request.userAttributes.email\n  });\n\n  db.once(\"open\", () => {\n    company\n      .save()\n      .then(() => {\n        return context.succeed(event);\n      })\n      .catch(err => {\n        return context.fail(\"Signup Failed. to saved to DB\");\n      })\n      .finally(() => {\n        db.close();\n      });\n  });\n};\n\nexport const user = (event, context, callback) => {\n  let db = {};\n  db = mongoose.connect(mongoString, {\n    useMongoClient: true\n    /* other options */\n  });\n  const id = event.pathParameters.id;\n\n  db.once(\"open\", () => {\n    User.find({ _id: event.pathParameters.id })\n      .then(user => {\n        callback(null, { statusCode: 200, body: JSON.stringify(user) });\n      })\n      .catch(err => {\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      })\n      .finally(() => {\n        // Close db connection or node event loop won't exit , and lambda will timeout\n        db.close();\n      });\n  });\n};\n\nexport const company = (event, context, callback) => {\n  const _id = event.pathParameters.id;\n\n  const response = company => ({\n    statusCode: 200,\n    headers: {\n      \"Access-Control-Allow-Origin\": \"*\" // Required for CORS support to work\n    },\n    body: JSON.stringify(company)\n  });\n\n  let db = {};\n  db = mongoose.connect(mongoString, {\n    useMongoClient: true\n    /* other options */\n  });\n\n  db.once(\"open\", () => {\n    Company.find({ _id })\n      .populate({\n        path: \"users\"\n      })\n      .then(company => {\n        callback(null, response(company));\n      })\n      .catch(err => {\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      })\n      .finally(() => {\n        // Close db connection or node event loop won't exit , and lambda will timeout\n        db.close();\n      });\n  });\n};\n\n// QUICKBOOKS API CALS\n\nexport const loadReport = (event, context, callback) => {\n  const { reportType, realmId, startDate, endDate } = event.body;\n  if (!realmId) {\n    callback(\n      null,\n      createErrorResponse(\n        500,\n        \"No realm ID.  QBO calls only work if the accounting scope was passed!\"\n      )\n    );\n  }\n  const token = tools.getToken(event.body.session);\n  // date format YYYY-MM-DD\n  const url =\n    config.api_uri +\n    realmId +\n    `/reports/${reportType}?start_date=${startDate}&end_date=${endDate}`;\n  console.log(\"Making API call to: \" + url);\n  const requestObj = {\n    url: url,\n    headers: {\n      Authorization: \"Bearer \" + token.accessToken,\n      Accept: \"application/json\"\n    }\n  };\n  request(requestObj, (err, response) => {\n    // Check if 401 response was returned - refresh tokens if so!\n    tools.checkForUnauthorized(event.body, requestObj, err, response).then(\n      ({ err, response }) => {\n        console.log(response.statusCode);\n        if (err || response.statusCode != 200) {\n          callback(\n            null,\n            createErrorResponse(\n              (err && err.statusCode) || response.statusCode,\n              (err && err.message) || response.body\n            )\n          );\n        }\n        callback(null, {\n          statusCode: 200,\n          headers: {\n            \"Access-Control-Allow-Origin\": \"*\" // Required for CORS support to work\n          },\n          body: JSON.stringify(response.body)\n        });\n      },\n      err => {\n        console.log(err);\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      }\n    );\n  });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./handler.js","module.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/json/stringify\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"babel-runtime/core-js/promise\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/promise\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"client-oauth2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"client-oauth2\"\n// module id = 8\n// module chunks = 0","module.exports = {\"issuer\":\"https://oauth.platform.intuit.com/op/v1\",\"authorization_endpoint\":\"https://appcenter.intuit.com/connect/oauth2\",\"token_endpoint\":\"https://oauth.platform.intuit.com/oauth2/v1/tokens/bearer\",\"userinfo_endpoint\":\"https://sandbox-accounts.platform.intuit.com/v1/openid_connect/userinfo\",\"revocation_endpoint\":\"https://developer.api.intuit.com/v2/oauth2/tokens/revoke\",\"jwks_uri\":\"https://oauth.platform.intuit.com/op/v1/jwks\",\"response_types_supported\":[\"code\"],\"subject_types_supported\":[\"public\"],\"id_token_signing_alg_values_supported\":[\"RS256\"],\"scopes_supported\":[\"openid\",\"email\",\"profile\",\"address\",\"phone\"],\"token_endpoint_auth_methods_supported\":[\"client_secret_post\",\"client_secret_basic\"],\"claims_supported\":[\"aud\",\"exp\",\"iat\",\"iss\",\"realmid\",\"sub\"]}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./tools/openid_configuration.json\n// module id = 9\n// module chunks = 0","module.exports = require(\"btoa\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"btoa\"\n// module id = 10\n// module chunks = 0","var atob = require(\"atob\");\nvar expect = require(\"expect\");\nvar request = require(\"request\");\nvar tools = require(\"./tools\");\nvar config = require(\"../config.json\");\n\nvar JWT = function() {\n  var jwt = this;\n\n  // Performs the correct JWT validation steps\n  this.validate = function(id_token, callback, errorFn) {\n    // https://developer.api.intuit.com/.well-known/openid_configuration/\n    var openid_configuration = tools.openid_configuration;\n\n    // Decode ID Token\n    var token_parts = id_token.split(\".\");\n    var idTokenHeader = JSON.parse(atob(token_parts[0]));\n    var idTokenPayload = JSON.parse(atob(token_parts[1]));\n    var idTokenSignature = atob(token_parts[2]);\n\n    // Step 1 : First check if the issuer is as mentioned in \"issuer\" in the discovery doc\n    expect(idTokenPayload.iss).toEqual(openid_configuration.issuer);\n\n    // Step 2 : check if the aud field in idToken is same as application's clientId\n    expect(idTokenPayload.aud).toEqual([process.env.QB_CONSUMER_KEY]);\n\n    // Step 3 : ensure the timestamp has not elapsed\n    expect(idTokenPayload.exp).toBeGreaterThan(Date.now() / 1000);\n\n    // Step 4: Verify that the ID token is properly signed by the issuer\n    jwt.getKeyFromJWKsURI(idTokenHeader.kid, function(key) {\n      var cert = jwt.getPublicKey(key.n, key.e);\n      // Validate the RSA encryption\n      require(\"jsonwebtoken\").verify(id_token, cert, function(err) {\n        if (err) errorFn(err);\n        else callback();\n      });\n    });\n  };\n\n  // Loads the correct key from JWKs URI:\n  // https://oauth.platform.intuit.com/op/v1/jwks\n  this.getKeyFromJWKsURI = function(kid, callback) {\n    var openid_configuration = tools.openid_configuration;\n\n    request(\n      {\n        url: openid_configuration.jwks_uri,\n        json: true\n      },\n      function(error, response, body) {\n        if (error || response.statusCode != 200) {\n          throw new Error(\"Could not reach JWK endpoint\");\n        }\n        // Find the key by KID\n        var key = body.keys.find(el => el.kid == kid);\n        callback(key);\n      }\n    );\n  };\n\n  // Creates a PEM style RSA public key, using the modulus (n) and exponent (e)\n  this.getPublicKey = function(modulus, exponent) {\n    var getPem = require(\"rsa-pem-from-mod-exp\");\n    var pem = getPem(modulus, exponent);\n    return pem;\n  };\n};\n\nmodule.exports = new JWT();\n\n\n\n// WEBPACK FOOTER //\n// ./tools/jwt.js","module.exports = require(\"atob\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"atob\"\n// module id = 12\n// module chunks = 0","module.exports = require(\"expect\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"expect\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 14\n// module chunks = 0","module.exports = require(\"rsa-pem-from-mod-exp\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"rsa-pem-from-mod-exp\"\n// module id = 15\n// module chunks = 0","module.exports = require(\"jwt-decode\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jwt-decode\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 17\n// module chunks = 0","import mongoose from \"mongoose\";\nconst Schema = mongoose.Schema;\nconst UserSchema = new Schema({\n  email: {\n    type: String,\n    required: true\n  },\n  firstname: {\n    type: String\n  },\n  lastname: {\n    type: String\n  },\n  session: String\n});\n\nconst User = mongoose.model(\"user\", UserSchema);\n\nexport default User;\n\n\n\n// WEBPACK FOOTER //\n// ./src/models/User.js","import mongoose from \"mongoose\";\nconst Schema = mongoose.Schema;\n\nconst CompanySchema = new Schema({\n  email: {\n    type: String,\n    required: true\n  },\n  users: [{ type: Schema.Types.ObjectId, ref: \"user\" }]\n});\n\nconst Company = mongoose.model(\"company\", CompanySchema);\n\nexport default Company;\n\n\n\n// WEBPACK FOOTER //\n// ./src/models/Company.js"],"sourceRoot":""}