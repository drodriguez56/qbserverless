{"version":3,"sources":["webpack:///webpack/bootstrap 8e06770465d2cef080ed","webpack:///external \"mongoose\"","webpack:///external \"request\"","webpack:///./config.json","webpack:///external \"babel-runtime/core-js/promise\"","webpack:///external \"csrf\"","webpack:///./tools/tools.js","webpack:///./handler.js","webpack:///external \"babel-runtime/core-js/json/stringify\"","webpack:///external \"client-oauth2\"","webpack:///./tools/openid_configuration.json","webpack:///external \"btoa\"","webpack:///./tools/jwt.js","webpack:///external \"atob\"","webpack:///external \"expect\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"rsa-pem-from-mod-exp\"","webpack:///external \"jwt-decode\"","webpack:///external \"bluebird\"","webpack:///./src/models/User.js","webpack:///./src/models/Company.js","webpack:///./src/models/Application.js"],"names":["Tokens","require","csrf","ClientOAuth2","request","config","Tools","tools","openid_configuration","authConfig","clientId","process","env","QB_CONSUMER_KEY","clientSecret","QB_CONSUMER_SECRET","redirectUri","authorizationUri","authorization_endpoint","accessTokenUri","token_endpoint","basicAuth","refreshEndpoints","url","configurationEndpoint","headers","Accept","err","response","console","log","json","JSON","parse","body","openid_uri","userinfo_endpoint","revoke_uri","revocation_endpoint","intuitAuth","checkForUnauthorized","req","requestObj","resolve","reject","statusCode","refreshTokens","session","then","newToken","Authorization","accessToken","token","getToken","refresh","saveToken","setScopes","flowName","scopes","containsOpenId","includes","generateAntiForgery","secret","secretSync","create","verifyAntiForgery","verify","clearToken","refreshToken","tokenType","data","createToken","module","exports","mongoString","MONGO_URL","Promise","createErrorResponse","message","qbAuthUrl","event","context","callback","uri","code","getUri","state","succeed","location","qbCallback","realmId","done","Error","errorFn","e","Referer","id_token","validate","connected","companyId","db","errs","user","mongooseId","connect","useMongoClient","once","findOneOrCreate","email","firstname","givenName","lastname","familyName","error","findById","populate","path","model","hasApplied","company","applications","filter","appl","_id","toString","length","application","push","all","save","catch","finally","close","createCompany","id","pathParameters","find","loadReport","reportType","date","api_uri","start","key","value","end","atob","expect","JWT","jwt","token_parts","split","idTokenHeader","idTokenPayload","idTokenSignature","iss","toEqual","issuer","aud","exp","toBeGreaterThan","Date","now","getKeyFromJWKsURI","kid","cert","getPublicKey","n","jwks_uri","keys","el","modulus","exponent","getPem","pem","Schema","UserSchema","type","String","required","Types","ObjectId","ref","statics","cb","self","findOne","result","User","CompanySchema","Company","ApplicationSchema","Application"],"mappings":"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","file":"handler.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 6);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 8e06770465d2cef080ed","module.exports = require(\"mongoose\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongoose\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"request\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"request\"\n// module id = 1\n// module chunks = 0","module.exports = {\"redirectUri\":\"http://localhost:3000/callback/\",\"configurationEndpoint\":\"https://developer.api.intuit.com/.well-known/openid_sandbox_configuration/\",\"api_uri\":\"https://sandbox-quickbooks.api.intuit.com/v3/company/\",\"scopes\":{\"sign_in_with_intuit\":[\"openid\",\"profile\",\"email\",\"phone\",\"address\"],\"connect_to_quickbooks\":[\"com.intuit.quickbooks.accounting\"],\"connect_handler\":[\"com.intuit.quickbooks.accounting\",\"openid\",\"profile\",\"email\",\"phone\",\"address\"]}}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./config.json\n// module id = 2\n// module chunks = 0","module.exports = require(\"babel-runtime/core-js/promise\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/promise\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"csrf\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"csrf\"\n// module id = 4\n// module chunks = 0","var Tokens = require(\"csrf\");\nvar csrf = new Tokens();\nvar ClientOAuth2 = require(\"client-oauth2\");\nvar request = require(\"request\");\nvar config = require(\"../config.json\");\n\nvar Tools = function() {\n  var tools = this;\n\n  // Use a local copy for startup.  This will be updated in refreshEndpoints() to call:\n  // https://developer.api.intuit.com/.well-known/openid_configuration/\n  this.openid_configuration = require(\"./openid_configuration.json\");\n\n  var authConfig = {\n    clientId: process.env.QB_CONSUMER_KEY,\n    clientSecret: process.env.QB_CONSUMER_SECRET,\n    redirectUri: config.redirectUri,\n    authorizationUri: this.openid_configuration.authorization_endpoint,\n    accessTokenUri: this.openid_configuration.token_endpoint\n  };\n\n  this.basicAuth = require(\"btoa\")(\n    authConfig.clientId + \":\" + authConfig.clientSecret\n  );\n\n  // Should be called at app start & scheduled to run once a day\n  // Get the latest OAuth/OpenID endpoints from Intuit\n  this.refreshEndpoints = function() {\n    request(\n      {\n        // Change this to Sandbox or non-sandbox in `config.json`\n        // Non-sandbox: https://developer.api.intuit.com/.well-known/openid_configuration/\n        // Sandbox: https://developer.api.intuit.com/.well-known/openid_sandbox_configuration/\n        url: config.configurationEndpoint,\n        headers: {\n          Accept: \"application/json\"\n        }\n      },\n      function(err, response) {\n        if (err) {\n          console.log(err);\n          return err;\n        }\n\n        // Update endpoints\n        var json = JSON.parse(response.body);\n        tools.openid_configuration = json;\n        tools.openid_uri = json.userinfo_endpoint;\n        tools.revoke_uri = json.revocation_endpoint;\n\n        // Re-create OAuth2 Client\n        authConfig.authorizationUri = json.authorization_endpoint;\n        authConfig.accessTokenUri = json.token_endpoint;\n        tools.intuitAuth = new ClientOAuth2(authConfig);\n      }\n    );\n  };\n\n  // Should be used to check for 401 response when making an API call.  If a 401\n  // response is received, refresh tokens should be used to get a new access token,\n  // and the API call should be tried again.\n  this.checkForUnauthorized = function(req, requestObj, err, response) {\n    return new Promise(function(resolve, reject) {\n      if (response.statusCode == 401) {\n        console.log(\"Received a 401 response!  Trying to refresh tokens.\");\n\n        // Refresh the tokens\n        tools.refreshTokens(req.session).then(\n          function(newToken) {\n            // Try API call again, with new accessToken\n            requestObj.headers.Authorization = \"Bearer \" + newToken.accessToken;\n            console.log(\"Trying again, making API call to: \" + requestObj.url);\n            request(requestObj, function(err, response) {\n              // Logic (including error checking) should be continued with new\n              // err/response objects.\n              resolve({ err, response });\n            });\n          },\n          function(err) {\n            // Error refreshing the tokens\n            reject(err);\n          }\n        );\n      } else {\n        // No 401, continue!\n        resolve({ err, response });\n      }\n    });\n  };\n\n  // Refresh Token should be called if access token expires, or if Intuit\n  // returns a 401 Unauthorized.\n  this.refreshTokens = function(session) {\n    var token = this.getToken(session);\n\n    // Call refresh API\n    return token.refresh().then(function(newToken) {\n      // Store the new tokens\n      tools.saveToken(session, newToken);\n      return newToken;\n    });\n  };\n\n  this.setScopes = function(flowName) {\n    authConfig.scopes = config.scopes[flowName];\n    tools.intuitAuth = new ClientOAuth2(authConfig);\n  };\n\n  this.containsOpenId = function() {\n    if (!authConfig.scopes) return false;\n    return authConfig.scopes.includes(\"openid\");\n  };\n\n  // Setup OAuth2 Client with values from config.json\n  this.intuitAuth = new ClientOAuth2(authConfig);\n\n  // Get anti-forgery token to use for state\n  this.generateAntiForgery = function(session) {\n    session.secret = csrf.secretSync();\n    return csrf.create(session.secret);\n  };\n\n  this.verifyAntiForgery = function(session, token) {\n    return csrf.verify(session.secret, token);\n  };\n\n  this.clearToken = function(session) {\n    session.accessToken = null;\n    session.refreshToken = null;\n    session.tokenType = null;\n    session.data = null;\n  };\n\n  // Save token into session storage\n  // In a real use-case, this is where tokens would have to be persisted (to a\n  // a SQL DB, for example).  Both access tokens and refresh tokens need to be\n  // persisted.  This should typically be stored against a user / realm ID, as well.\n  this.saveToken = function(session, token) {\n    session.accessToken = token.accessToken;\n    session.refreshToken = token.refreshToken;\n    session.tokenType = token.tokenType;\n    session.data = token.data;\n    return session;\n  };\n\n  // Get the token object from session storage\n  this.getToken = function(session) {\n    if (!session.accessToken) return null;\n\n    return tools.intuitAuth.createToken(\n      session.accessToken,\n      session.refreshToken,\n      session.tokenType,\n      session.data\n    );\n  };\n\n  this.refreshEndpoints();\n};\n\nmodule.exports = new Tools();\n\n\n\n// WEBPACK FOOTER //\n// ./tools/tools.js","import request from \"request\";\nimport Tokens from \"csrf\";\nimport tools from \"./tools/tools\";\nimport jwt from \"./tools/jwt\";\nimport decode from \"jwt-decode\";\nimport bluebird from \"bluebird\";\n\nimport mongoose from \"mongoose\";\nimport User from \"./src/models/User\";\nimport Company from \"./src/models/Company\";\nimport Application from \"./src/models/Application\";\n\nimport config from \"./config.json\";\n\nconst csrf = new Tokens();\nconst mongoString = process.env.MONGO_URL;\n\nmongoose.Promise = bluebird;\n\nconst generateAntiForgery = session => {\n  session.secret = csrf.secretSync();\n  return csrf.create(session.secret);\n};\n\nconst createErrorResponse = (statusCode, message) => ({\n  statusCode: statusCode || 501,\n  headers: { \"Content-Type\": \"text/plain\", \"Access-Control-Allow-Origin\": \"*\" },\n  body: message || \"Incorrect id\"\n});\n\nexport const qbAuthUrl = (event, context, callback) => {\n  tools.setScopes(\"connect_handler\");\n  // Constructs the authorization URI.\n  const uri = tools.intuitAuth.code.getUri({\n    // Add CSRF protection\n    state: tools.generateAntiForgery({})\n  });\n\n  console.log(\"Redirecting to authorization uri: \" + uri);\n\n  context.succeed({ location: uri });\n};\n\nexport const qbCallback = (event, context, callback) => {\n  const realmId = event.body.realmId;\n  if (!realmId) {\n    return context.done(\n      new Error(\"Error - cant connect without company id\"),\n      {}\n    );\n  }\n  // if (e)) {\n  //   return context.done(\n  //     new Error(\"Error - invalid anti-forgery CSRF response!\"),\n  //     {}\n  //   );\n  // }\n  const errorFn = e => {\n    console.log(e);\n    return callback(new Error(e), {});\n  };\n  tools.intuitAuth.code.getToken(event.headers.Referer).then(\n    function(token) {\n      // TODO: Store token - this would be where tokens would need to be\n      // save realmIdnd token as new client on company\n      const session = tools.saveToken({}, token);\n      if (token.data.id_token) {\n        try {\n          // We should decode and validate the ID token\n          jwt.validate(\n            token.data.id_token,\n            () => {\n              callback(null, { session: session });\n            },\n            errorFn\n          );\n        } catch (e) {\n          return errorFn(e);\n        }\n      } else {\n        callback(null, { message: \"connected\" });\n      }\n    },\n    err => {\n      return errorFn(err);\n    }\n  );\n};\n\nexport const connected = (event, context, callback) => {\n  const companyId = event.body.companyId;\n  if (!companyId)\n    return context.done(\n      new Error(\n        \"No realm ID.  QBO calls only work if the accounting scope was passed!\"\n      ),\n      {}\n    );\n  const token = tools.getToken(event.body.session);\n  const url = tools.openid_configuration.userinfo_endpoint;\n  console.log(\"Making API call to: \" + url);\n  const requestObj = {\n    url: url,\n    headers: {\n      Authorization: \"Bearer \" + token.accessToken,\n      Accept: \"application/json\"\n    }\n  };\n  request(requestObj, (err, response) => {\n    // Check if 401 response was returned - refresh tokens if so!\n    tools.checkForUnauthorized(event.body, requestObj, err, response).then(\n      ({ err, response }) => {\n        if (err || response.statusCode != 200) {\n          return context.done(new Error(err), {});\n        }\n\n        // API Call was a success!\n        const data = JSON.parse(response.body);\n        let db = {};\n        let errs = {};\n        let user = {};\n        const mongooseId = \"_id\";\n\n        db = mongoose.connect(mongoString, {\n          useMongoClient: true\n        });\n        db.once(\"open\", () => {\n          User.findOneOrCreate(\n            {\n              email: data.email,\n              firstname: data.givenName,\n              lastname: data.familyName,\n              session: JSON.stringify(event.body.session)\n            },\n            (error, user) => {\n              if (error) {\n                callback(\n                  null,\n                  createErrorResponse(err.statusCode, err.message)\n                );\n              }\n              Company.findById(companyId)\n                .populate({\n                  path: \"applications\",\n                  populate: {\n                    path: \"user\",\n                    model: \"user\"\n                  }\n                })\n                .then(company => {\n                  const hasApplied = company.applications.filter(appl => {\n                    return appl.user._id.toString() === user._id.toString();\n                  });\n                  console.log(hasApplied.length);\n                  if (hasApplied.length > 0) {\n                    return callback(\n                      null,\n                      createErrorResponse(422, \"already applied\")\n                    );\n                  } else {\n                    const application = new Application({ company, user });\n                    user.applications.push(application);\n                    company.applications.push(application);\n                    return Promise.all([\n                      user.save(),\n                      application.save(),\n                      company.save()\n                    ]).then(() => {\n                      console.log(\"saved all\");\n                      return callback(null, { statusCode: 200, body: \"saved\" });\n                    });\n                  }\n                })\n                .catch(err => {\n                  callback(\n                    null,\n                    createErrorResponse(err.statusCode, err.message)\n                  );\n                })\n                .finally(() => {\n                  db.close();\n                });\n            }\n          );\n        });\n      },\n      err => {\n        console.log(err);\n        return context.done(new Error(err), {});\n      }\n    );\n  });\n};\n\n//USER\n\nexport const createCompany = (event, context, callback) => {\n  let db = {};\n  let errs = {};\n  let company = {};\n  const mongooseId = \"_id\";\n\n  db = mongoose.connect(mongoString, {\n    useMongoClient: true\n  });\n  const body = JSON.parse(event.body);\n  company = new Company({\n    email: body.email\n  });\n\n  db.once(\"open\", () => {\n    company\n      .save()\n      .then(() => {\n        callback(null, { statusCode: 200, body: \"saved\" });\n      })\n      .catch(err => {\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      })\n      .finally(() => {\n        db.close();\n      });\n  });\n};\n\nexport const user = (event, context, callback) => {\n  let db = {};\n  db = mongoose.connect(mongoString, {\n    useMongoClient: true\n    /* other options */\n  });\n  const id = event.pathParameters.id;\n\n  db.once(\"open\", () => {\n    User.find({ _id: event.pathParameters.id })\n      .then(user => {\n        callback(null, { statusCode: 200, body: JSON.stringify(user) });\n      })\n      .catch(err => {\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      })\n      .finally(() => {\n        // Close db connection or node event loop won't exit , and lambda will timeout\n        db.close();\n      });\n  });\n};\n\nexport const company = (event, context, callback) => {\n  const _id = event.pathParameters.id;\n\n  const response = company => ({\n    statusCode: 200,\n    headers: {\n      \"Access-Control-Allow-Origin\": \"*\" // Required for CORS support to work\n    },\n    body: JSON.stringify(company)\n  });\n\n  let db = {};\n  db = mongoose.connect(mongoString, {\n    useMongoClient: true\n    /* other options */\n  });\n\n  db.once(\"open\", () => {\n    Company.find({ _id })\n      .populate({\n        path: \"applications\",\n        populate: {\n          path: \"user\",\n          model: \"user\"\n        }\n      })\n      .then(company => {\n        callback(null, response(company));\n      })\n      .catch(err => {\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      })\n      .finally(() => {\n        // Close db connection or node event loop won't exit , and lambda will timeout\n        db.close();\n      });\n  });\n};\n\n// QUICKBOOKS API CALS\n\nexport const loadReport = (event, context, callback) => {\n  const { reportType, realmId, date } = event.body;\n  if (!realmId) {\n    callback(\n      null,\n      createErrorResponse(\n        500,\n        \"No realm ID.  QBO calls only work if the accounting scope was passed!\"\n      )\n    );\n  }\n  console.log(date);\n\n  const token = tools.getToken(event.body.session);\n  // date format YYYY-MM-DD\n  const url =\n    config.api_uri +\n    realmId +\n    `/reports/${reportType}?${date.start.key}=${date.start.value}&${\n      date.end.key\n    }=${date.end.value}`;\n  console.log(\"Making API call to: \" + url);\n  const requestObj = {\n    url: url,\n    headers: {\n      Authorization: \"Bearer \" + token.accessToken,\n      Accept: \"application/json\"\n    }\n  };\n  request(requestObj, (err, response) => {\n    // Check if 401 response was returned - refresh tokens if so!\n    tools.checkForUnauthorized(event.body, requestObj, err, response).then(\n      ({ err, response }) => {\n        console.log(response.statusCode);\n        if (err || response.statusCode != 200) {\n          callback(\n            null,\n            createErrorResponse(\n              (err && err.statusCode) || response.statusCode,\n              (err && err.message) || response.body\n            )\n          );\n        }\n        callback(null, {\n          statusCode: 200,\n          headers: {\n            \"Access-Control-Allow-Origin\": \"*\" // Required for CORS support to work\n          },\n          body: JSON.stringify(response.body)\n        });\n      },\n      err => {\n        console.log(err);\n        callback(null, createErrorResponse(err.statusCode, err.message));\n      }\n    );\n  });\n};\n\n\n\n// WEBPACK FOOTER //\n// ./handler.js","module.exports = require(\"babel-runtime/core-js/json/stringify\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"babel-runtime/core-js/json/stringify\"\n// module id = 7\n// module chunks = 0","module.exports = require(\"client-oauth2\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"client-oauth2\"\n// module id = 8\n// module chunks = 0","module.exports = {\"issuer\":\"https://oauth.platform.intuit.com/op/v1\",\"authorization_endpoint\":\"https://appcenter.intuit.com/connect/oauth2\",\"token_endpoint\":\"https://oauth.platform.intuit.com/oauth2/v1/tokens/bearer\",\"userinfo_endpoint\":\"https://sandbox-accounts.platform.intuit.com/v1/openid_connect/userinfo\",\"revocation_endpoint\":\"https://developer.api.intuit.com/v2/oauth2/tokens/revoke\",\"jwks_uri\":\"https://oauth.platform.intuit.com/op/v1/jwks\",\"response_types_supported\":[\"code\"],\"subject_types_supported\":[\"public\"],\"id_token_signing_alg_values_supported\":[\"RS256\"],\"scopes_supported\":[\"openid\",\"email\",\"profile\",\"address\",\"phone\"],\"token_endpoint_auth_methods_supported\":[\"client_secret_post\",\"client_secret_basic\"],\"claims_supported\":[\"aud\",\"exp\",\"iat\",\"iss\",\"realmid\",\"sub\"]}\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./tools/openid_configuration.json\n// module id = 9\n// module chunks = 0","module.exports = require(\"btoa\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"btoa\"\n// module id = 10\n// module chunks = 0","var atob = require(\"atob\");\nvar expect = require(\"expect\");\nvar request = require(\"request\");\nvar tools = require(\"./tools\");\nvar config = require(\"../config.json\");\n\nvar JWT = function() {\n  var jwt = this;\n\n  // Performs the correct JWT validation steps\n  this.validate = function(id_token, callback, errorFn) {\n    // https://developer.api.intuit.com/.well-known/openid_configuration/\n    var openid_configuration = tools.openid_configuration;\n\n    // Decode ID Token\n    var token_parts = id_token.split(\".\");\n    var idTokenHeader = JSON.parse(atob(token_parts[0]));\n    var idTokenPayload = JSON.parse(atob(token_parts[1]));\n    var idTokenSignature = atob(token_parts[2]);\n\n    // Step 1 : First check if the issuer is as mentioned in \"issuer\" in the discovery doc\n    expect(idTokenPayload.iss).toEqual(openid_configuration.issuer);\n\n    // Step 2 : check if the aud field in idToken is same as application's clientId\n    expect(idTokenPayload.aud).toEqual([process.env.QB_CONSUMER_KEY]);\n\n    // Step 3 : ensure the timestamp has not elapsed\n    expect(idTokenPayload.exp).toBeGreaterThan(Date.now() / 1000);\n\n    // Step 4: Verify that the ID token is properly signed by the issuer\n    jwt.getKeyFromJWKsURI(idTokenHeader.kid, function(key) {\n      var cert = jwt.getPublicKey(key.n, key.e);\n      // Validate the RSA encryption\n      require(\"jsonwebtoken\").verify(id_token, cert, function(err) {\n        if (err) errorFn(err);\n        else callback();\n      });\n    });\n  };\n\n  // Loads the correct key from JWKs URI:\n  // https://oauth.platform.intuit.com/op/v1/jwks\n  this.getKeyFromJWKsURI = function(kid, callback) {\n    var openid_configuration = tools.openid_configuration;\n\n    request(\n      {\n        url: openid_configuration.jwks_uri,\n        json: true\n      },\n      function(error, response, body) {\n        if (error || response.statusCode != 200) {\n          throw new Error(\"Could not reach JWK endpoint\");\n        }\n        // Find the key by KID\n        var key = body.keys.find(el => el.kid == kid);\n        callback(key);\n      }\n    );\n  };\n\n  // Creates a PEM style RSA public key, using the modulus (n) and exponent (e)\n  this.getPublicKey = function(modulus, exponent) {\n    var getPem = require(\"rsa-pem-from-mod-exp\");\n    var pem = getPem(modulus, exponent);\n    return pem;\n  };\n};\n\nmodule.exports = new JWT();\n\n\n\n// WEBPACK FOOTER //\n// ./tools/jwt.js","module.exports = require(\"atob\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"atob\"\n// module id = 12\n// module chunks = 0","module.exports = require(\"expect\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"expect\"\n// module id = 13\n// module chunks = 0","module.exports = require(\"jsonwebtoken\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jsonwebtoken\"\n// module id = 14\n// module chunks = 0","module.exports = require(\"rsa-pem-from-mod-exp\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"rsa-pem-from-mod-exp\"\n// module id = 15\n// module chunks = 0","module.exports = require(\"jwt-decode\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"jwt-decode\"\n// module id = 16\n// module chunks = 0","module.exports = require(\"bluebird\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"bluebird\"\n// module id = 17\n// module chunks = 0","import mongoose from \"mongoose\";\n\nconst Schema = mongoose.Schema;\nconst UserSchema = new Schema({\n  email: {\n    type: String,\n    required: true\n  },\n  firstname: {\n    type: String\n  },\n  lastname: {\n    type: String\n  },\n  session: String,\n  applications: [{ type: Schema.Types.ObjectId, ref: \"application\" }]\n});\nUserSchema.statics.findOneOrCreate = function(user, cb) {\n  const self = this;\n  self.findOne({ email: user.email }, (err, result) => {\n    return result\n      ? cb(err, result)\n      : self.create(user, (err, result) => {\n          return cb(err, result);\n        });\n  });\n};\nconst User = mongoose.model(\"user\", UserSchema);\n\nexport default User;\n\n\n\n// WEBPACK FOOTER //\n// ./src/models/User.js","import mongoose from \"mongoose\";\nconst Schema = mongoose.Schema;\n\nconst CompanySchema = new Schema({\n  email: {\n    type: String,\n    required: true\n  },\n  applications: [{ type: Schema.Types.ObjectId, ref: \"application\" }]\n});\n\nconst Company = mongoose.model(\"company\", CompanySchema);\n\nexport default Company;\n\n\n\n// WEBPACK FOOTER //\n// ./src/models/Company.js","import mongoose from \"mongoose\";\nconst Schema = mongoose.Schema;\n\nconst ApplicationSchema = new Schema({\n  company: { type: Schema.Types.ObjectId, ref: \"company\" },\n  user: { type: Schema.Types.ObjectId, ref: \"user\" }\n});\n\nconst Application = mongoose.model(\"application\", ApplicationSchema);\n\nexport default Application;\n\n\n\n// WEBPACK FOOTER //\n// ./src/models/Application.js"],"sourceRoot":""}